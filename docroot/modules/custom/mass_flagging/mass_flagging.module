<?php

/**
 * @file
 * Contains mass_flagging.module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Url;

const WATCH_FLAG = 'watch_content';

/**
 * Implements hook_help().
 */
function mass_flagging_help($route_name, RouteMatchInterface $route_match) {
  module_load_include('inc', 'mass_flagging');
  switch ($route_name) {
    // Main module help for the mass_flagging module.
    case 'help.page.mass_flagging':
      return get_mass_flagging_help_text();

    default:
  }
}

/**
 * Implements hook_preprocess_page().
 */
function mass_flagging_preprocess_page(&$variables) {

  $user = \Drupal::currentUser();

  // Check if page is node.
  if (isset($variables['node']) && $variables['node'] instanceof Node) {
    $node = $variables['node'];

    // Check if user has correct 'watching' permissions.
    if ($user->hasPermission('flag watch_content') &&
      $user->hasPermission('unflag watch_content')) {

      $flag = \Drupal::service('flag.link_builder');
      $watch_content_link = $flag->build($node->getEntityTypeId(), $node->id(), 'watch_content');

      $variables['page']['watch_content_link'] = $watch_content_link;
    }

    // Check if user has correct 'flagging' permissions.
    if ($user->hasPermission('mass_flagging flag content')) {
      $flag_content_link_builder = \Drupal::service('mass_flagging.flag_content.link_builder');
      $flag_content_link = $flag_content_link_builder->build($node->id());

      $variables['page']['flag_content_link'] = $flag_content_link;
    }

    $variables['#attached']['library'][] = 'mass_flagging/flag-link';
  }
}

/**
 * Implements hook_node_update().
 */
function mass_flagging_node_update(EntityInterface $node) {
  mass_flagging_node_update_insert_send_notifications($node);
  mass_flagging_node_update_insert_add_watcher($node);
}

/**
 * Implements hook_node_insert().
 */
function mass_flagging_node_insert(EntityInterface $node) {
  mass_flagging_node_update_insert_add_watcher($node);
}

/**
 * Send notifications to users who are watchers.
 *
 * @param \Drupal\Core\Entity\EntityInterface $node
 *   The node object that is being updated or inserted.
 */
function mass_flagging_node_update_insert_send_notifications(EntityInterface $node) {
  // Only send notifications after a node has been published.
  // Load canonical node to check if it has ever been published.
  // This is necessary as drafts will have a current state of unpublished while
  // a node is fact published.
  $canonical_node = Drupal::entityTypeManager()->getStorage('node')->load($node->id());
  if ($canonical_node->isPublished()) {
    $flag_service = \Drupal::service('flag');
    $watch_flag = \Drupal::entityTypeManager()
      ->getStorage('flag')
      ->load(WATCH_FLAG);

    $node_watcher_users = $flag_service->getFlaggingUsers($node, $watch_flag);

    if ($node_watcher_users) {

      // Create diff url, @see \modules\contrib\diff\diff.routing.yml.
      $route_parameters = [
        'node' => $node->id(),
        // Compare previous revision (left) to current revision (right).
        'left_revision' => $node->getLoadedRevisionId(),
        'right_revision' => $node->getRevisionId(),
        'filter' => 'split_fields',
      ];

      $diff_url = Url::fromRoute('diff.revisions_diff', $route_parameters)
        ->setAbsolute()->toString();

      // Create Message.
      $author_username = $node->getRevisionUser()->getDisplayName();
      $params['node_title'] = $node->label();
      $node_edit_time = \Drupal::service('date.formatter')
        ->format($node->getCreatedTime());
      $url = Url::fromRoute('entity.node.revision', [
        'node' => $node->id(),
        'node_revision' => $node->vid->value,
      ]);
      $version_url_string = $url->setAbsolute()->toString();
      $params['message'] = t("Hello,\r\nUser @author_username added a new version of the @node_type '@node_title' at @node_edit_time.\r\n\r\nTo see what changed between the prior draft and this revision, go to:\r\n:version_url_string\r\n\r\nTo see what changed between the previous and new versions, go to:\r\n:diff_url\r\n\r\nRegards,\r\nMassGov Watchers",
        [
          '@author_username' => $author_username,
          '@node_type' => node_get_type_label($node),
          '@node_title' => $params['node_title'],
          '@node_edit_time' => $node_edit_time,
          ':version_url_string' => $version_url_string,
          ':diff_url' => $diff_url,
        ]);

      // Create queue to process email for watchers.
      $queue = \Drupal::queue('mass_flagging_email_queue');
      $queue->createQueue();

      // Do not notify the user who creates draft or publishes node.
      $do_not_send_list = [
        \Drupal::currentUser()->id(),
      ];

      foreach ($node_watcher_users as $watcher) {
        if (!in_array($watcher->id(), $do_not_send_list)) {
          $data['params'] = $params;
          $data['user'] = $watcher;
          $queue->createItem($data);
        }
      }
    }
  }
}

/**
 * Add a user as a watcher for updates or inserts.
 *
 * @param \Drupal\Core\Entity\EntityInterface $node
 *   The node object that is being updated or inserted.
 */
function mass_flagging_node_update_insert_add_watcher(EntityInterface $node) {
  // Add flag for the user editing or creating the node.
  $watch_flag = \Drupal::entityTypeManager()->getStorage('flag')->load(WATCH_FLAG);
  $bundles = $watch_flag->getBundles();
  if (!empty($bundles) && in_array($node->bundle(), $bundles)) {
    $flag_service = \Drupal::service('flag');
    $user = \Drupal::currentUser();
    if (!$user->isAnonymous()) {
      $flagging = $flag_service->getEntityFlaggings($watch_flag, $node, $user);
      if (empty($flagging)) {
        // Adds the flag.
        $flag_service->flag($watch_flag, $node);

        // Gets flag link for unwatching content.
        $flag_link_type_plugin = $watch_flag->getLinkTypePlugin();
        $flag_url = $flag_link_type_plugin->getAsLink($watch_flag, $node)->getUrl();
        $flag_url->setOption('query', ['destination' => $node->toUrl()->toString()]);
        $flag_url = $flag_url->toString();
        $flag_title = $watch_flag->getShortText('unflag');

        // Notifies user that they are now automatically watching the node.
        drupal_set_message(t('You are now watching @node_type %node_title. You will be notified of any future changes made to this content. <a href=":help_url" title="Mass Flagging help page">Learn more about this functionality</a>, or <a href=":flag_url" title="@flag_title">stop watching this content</a>.', [
          '@node_type' => node_get_type_label($node),
          '%node_title' => $node->label(),
          ':help_url' => Url::fromRoute('help.page', ['name' => 'mass_flagging'])->toString(),
          ':flag_url' => $flag_url,
          '@flag_title' => $flag_title,
        ]));
      }
    }
  }
}

/**
 * Implements hook_mail().
 */
function mass_flagging_mail($key, &$message, $params) {
  $options = ['langcode' => $message['langcode']];
  switch ($key) {
    case 'email_queue':
      $message['from'] = \Drupal::config('system.site')->get('mail');
      $message['subject'] = t('Watch Report: @title', ['@title' => $params['node_title']], $options);
      $message['body'][] = $params['message'];
      break;
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function mass_flagging_form_contact_message_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Alters `flag_content` form used by mass_flagging module.
  if ($form_id == 'contact_message_flag_content_form') {
    $form['field_content_flagged']['#disabled'] = TRUE;
    $form['actions']['preview']['#access'] = FALSE;
  }
}

/**
 * Implements hook_mail_alter().
 */
function mass_flagging_mail_alter(&$message) {
  // Alters emails sent by `flag_content` form used by mass_flagging module.
  if (!empty($message['id']) && $message['id'] == 'contact_page_mail' && $message['params']['contact_form']->id() == 'flag_content') {
    // Gets entities for accessing submitted field values from contact form.
    $contact_message = $message['params']['contact_message'];
    $sender = $message['params']['sender'];
    $content_flagged = $contact_message->field_content_flagged->entity;

    // Sets email subject line.
    $message['subject'] .= t('"@node_title"', ['@node_title' => $content_flagged->label()]);

    // Resets email body.
    $message['body'] = [];

    // Sets new email body.
    $body = t("Flagger Name: @name\r\nFlagger Email: @email\r\nNode URL: @url\r\nFlagger Feedback:\r\n@feedback", [
      '@name' => $sender->getAccountName(),
      '@email' => $sender->getEmail(),
      '@url' => Url::fromRoute(
        'entity.node.canonical',
        ['node' => $content_flagged->id()],
        ['absolute' => TRUE]
      )->toString(),
      '@feedback' => $contact_message->field_reason_flagged->value,
    ]);
    $message['body'][] = $body;
  }
}
