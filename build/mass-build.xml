<project name="mass-build" default="status">

  <target name="mass-drupal-test" description="Run Drupal tests.">
      <property name="build.test_output" value="/dev/null" />

      <if>
          <available file="${build.test_output}" type="dir" />
          <then>
              <property name="behat.args" value="--strict --format=junit --out=${build.test_output}/behat" />
          </then>
          <else>
              <property name="behat.args" value="" />
          </else>
      </if>

      <exec command="vendor/bin/behat ${behat.args}" checkreturn="true" logoutput="true" />
  </target>

  <!-- Target: install-from-acquia -->
  <target name="install-from-acquia" description="Use the Acquia stage environment for installation.">
      <!-- Configure the 'drush' Phing task. -->
      <taskdef name="drush" classname="Drush\Task" />
      <property name="drush.bin" value="${build.dir}/vendor/bin/drush" />
      <property name="drush.config" value="${build.dir}/conf/drushrc.php" />
      <property name="drush.include" value="${build.dir}/artifacts/acquiacloud/.drush" />
      <property name="drush.alias-path" value="${build.dir}/artifacts/acquiacloud/.drush" />

      <if>
          <not><available file="${build.dir}/artifacts/acquiacloud" type="dir" /></not>
          <then>
              <!-- Whitespace is significant within this <echo> -->
              <echo>Acquia Cloud credentials are required for deployment.
          1. Log in to your Acquia account
          2. Navigate to the "Credentials" tab under your profile
          3. Under the "Drush Integration" heading, click the "Download Drush aliases" link
          4. This will download acquiacloud.tar.gz
          5. Unzip this archive
          6. Place the resulting directory within this project's "artifacts" directory
          7. You should now have your Acquia Cloud credentials available at "${build.dir}/artifacts/acquiacloud"</echo>
              <fail message="Acquia Cloud credentials missing." />
          </then>
      </if>

      <if>
        <not><available file="${build.dir}/artifacts/databases" type="dir" /></not>
        <then>
          <echo>Please create a directory for databases at "${build.dir}/artifacts/databases".</echo>
          <fail message="No database working directory." />
        </then>
      </if>

      <!-- Which environment will we be pulling from? -->
      <property name="deploy.site_alias" value="@massgovdemo.test" />
      <input propertyname="deploy.site_alias" validargs="@massgovdemo.dev,@massgovdemo.test">Acquia environment to pull from? </input>

      <!-- This cannot be a drush command because we cannot run it with the
           root parameter... exec works okay for this one-off. -->
      <echo>Downloading the database from Acquia.</echo>
      <exec command="drush --nocolor --yes ${deploy.site_alias} sql-dump > ${acquia.databases}/remote-db.sql" />
      <drush command="sql-drop" assume="yes" />
      <drush command="sql-cli &lt; ${acquia.databases}/remote-db.sql" />

      <!-- DB is installed! We can remove the file now. -->
      <delete file="${acquia.databases}/remote-db.sql" />

      <echo>Preforming local database operations.</echo>
      <!-- Scrub the DB of PII & reset the admin password. -->
      <drush command="sql-sanitize" assume="yes">
        <option name="sanitize-password">admin</option>
        <option name="sanitize-email">user+%uid@localhost</option>
      </drush>

      <drush command="upwd">
        <option name="password">admin</option>
        <param>admin</param>
      </drush>

      <echo>Reticulating splines.</echo>
      <drush command="cr" />

      <!-- Now that we have the database, we need to rsync files down. -->
      <!-- Sync the files directory -->
      <!-- The SSH user. -->
      <echo>Preparing for file sync.</echo>
      <drush command="site-alias" returnProperty="deploy.host">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="remote-host" />
      </drush>

      <!-- The SSH host. -->
      <drush command="site-alias" returnProperty="deploy.username">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="remote-user" />
      </drush>

      <!-- The Acquia docroot. -->
      <drush command="site-alias" returnProperty="deploy.drupal.root">
          <param>${deploy.site_alias}</param>
          <option name="format" value="csv" />
          <option name="fields" value="root" />
      </drush>

      <property name="deploy.file_source" value="${deploy.username}@${deploy.host}:${deploy.drupal.root}/files" />
      <property name="deploy.file_dest" value="${build.dir}/${drupal.root}/${drupal.settings.file_public_path}" />

      <echo>Syncing files.</echo>
      <filesync
           sourcedir="${deploy.file_source}"
           destinationdir="${deploy.file_dest}"
           options="-rltDvPh" />
  </target>

</project>
